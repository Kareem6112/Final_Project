/*
 * TFT_prog.c
 *
 * Created: 5/20/2025 8:26:31 PM
 *  Author: kareem
 */ 
#include "../../LIB/BIT_MATH.h"
#include "../../LIB/STD_TYPES.h"
#include "../../MCAL/SPI/SPI_interface.h"
#include "TFT_interface.h"
#include "avr/io.h"
#define F_CPU 16000000UL
#include "util/delay.h"
void ILI9341_Init()
{
	// Set control pins as output
	DDRC |= (1 << ILI9341_DC_PIN) | (1 << ILI9341_RST_PIN) | (1 << ILI9341_CS_PIN);
	
	// Reset the display
	PORTC &= ~(1 << ILI9341_RST_PIN);
	_delay_ms(50);
	PORTC |= (1 << ILI9341_RST_PIN);
	_delay_ms(50);
	
	// Send initialization commands
	ILI9341_SendCommand(ILI9341_CMD_RESET);
	_delay_ms(120);
	ILI9341_SendCommand(ILI9341_CMD_SLEEP_OUT);
	_delay_ms(120);
	ILI9341_SendCommand(ILI9341_CMD_DISPLAY_ON);
	_delay_ms(50);
	ILI9341_SendCommand(ILI9341_CMD_PIXEL_FORMAT_SET);
	ILI9341_SendData(0x55); // 16-bit color
	_delay_ms(10);
}

void ILI9341_SendCommand(u8 cmd)
{
	// Set DC low for command mode
	PORTC &= ~(1 << ILI9341_DC_PIN);
	// Select the display
	PORTC &= ~(1 << ILI9341_CS_PIN);
	// Send the command
	SPI_voidMasterSendData(cmd);
	// Deselect the display
	PORTC |= (1 << ILI9341_CS_PIN);
}

void ILI9341_SendData(u8 data)
{
	// Set DC high for data mode
	PORTC |= (1 << ILI9341_DC_PIN);
	// Select the display
	PORTC &= ~(1 << ILI9341_CS_PIN);
	// Send the data
	SPI_voidMasterSendData(data);
	// Deselect the display
	PORTC |= (1 << ILI9341_CS_PIN);
}

void ILI9341_FillScreen(u16 color)
{
	ILI9341_SendCommand(ILI9341_CMD_MEMORY_WRITE);
	for (u64 i = 0; i <  320UL * 240; i++)
	{
		ILI9341_SendData(color >> 8);   // Send high byte
		ILI9341_SendData(color & 0xFF); // Send low byte
	}
}


void ILI9341_SetAddressWindow(u16 x0, u16 y0, u16 x1, u16 y1)
{
	ILI9341_SendCommand(0x2A); // Column address set
	ILI9341_SendData(x0 >> 8);
	ILI9341_SendData(x0 & 0xFF);
	ILI9341_SendData(x1 >> 8);
	ILI9341_SendData(x1 & 0xFF);

	ILI9341_SendCommand(0x2B); // Row address set
	ILI9341_SendData(y0 >> 8);
	ILI9341_SendData(y0 & 0xFF);
	ILI9341_SendData(y1 >> 8);
	ILI9341_SendData(y1 & 0xFF);

	ILI9341_SendCommand(0x2C); // Memory write
}
void ILI9341_DrawPixel(u16 x, u16 y, u16 color)
{
	ILI9341_SetAddressWindow(x, y, x, y);
	ILI9341_SendData(color >> 8);
	ILI9341_SendData(color & 0xFF);
}

const uint8_t font_5x7[96][5] = {
	{0x00,0x00,0x00,0x00,0x00}, // ' ' 0x20
	{0x00,0x00,0x5F,0x00,0x00}, // '!' 0x21
	{0x00,0x07,0x00,0x07,0x00}, // '"' 0x22
	{0x14,0x7F,0x14,0x7F,0x14}, // '#' 0x23
	{0x24,0x2A,0x7F,0x2A,0x12}, // '$' 0x24
	{0x23,0x13,0x08,0x64,0x62}, // '%' 0x25
	{0x36,0x49,0x55,0x22,0x50}, // '&' 0x26
	{0x00,0x05,0x03,0x00,0x00}, // ''' 0x27
	{0x00,0x1C,0x22,0x41,0x00}, // '(' 0x28
	{0x00,0x41,0x22,0x1C,0x00}, // ')' 0x29
	{0x14,0x08,0x3E,0x08,0x14}, // '*' 0x2A
	{0x08,0x08,0x3E,0x08,0x08}, // '+' 0x2B
	{0x00,0x50,0x30,0x00,0x00}, // ',' 0x2C
	{0x08,0x08,0x08,0x08,0x08}, // '-' 0x2D
	{0x00,0x60,0x60,0x00,0x00}, // '.' 0x2E
	{0x20,0x10,0x08,0x04,0x02}, // '/' 0x2F
	{0x3E,0x51,0x49,0x45,0x3E}, // '0' 0x30
	{0x00,0x42,0x7F,0x40,0x00}, // '1' 0x31
	{0x42,0x61,0x51,0x49,0x46}, // '2' 0x32
	{0x21,0x41,0x45,0x4B,0x31}, // '3' 0x33
	{0x18,0x14,0x12,0x7F,0x10}, // '4' 0x34
	{0x27,0x45,0x45,0x45,0x39}, // '5' 0x35
	{0x3C,0x4A,0x49,0x49,0x30}, // '6' 0x36
	{0x01,0x71,0x09,0x05,0x03}, // '7' 0x37
	{0x36,0x49,0x49,0x49,0x36}, // '8' 0x38
	{0x06,0x49,0x49,0x29,0x1E}, // '9' 0x39
	{0x00,0x36,0x36,0x00,0x00}, // ':' 0x3A
	{0x00,0x56,0x36,0x00,0x00}, // ';' 0x3B
	{0x08,0x14,0x22,0x41,0x00}, // '<' 0x3C
	{0x14,0x14,0x14,0x14,0x14}, // '=' 0x3D
	{0x00,0x41,0x22,0x14,0x08}, // '>' 0x3E
	{0x02,0x01,0x51,0x09,0x06}, // '?' 0x3F
	{0x32,0x49,0x79,0x41,0x3E}, // '@' 0x40
	{0x7E,0x11,0x11,0x11,0x7E}, // 'A' 0x41
	{0x36,0x49,0x49,0x49,0x7F}, // 'B' 0x42
	{0x22,0x41,0x41,0x41,0x3E}, // 'C' 0x43
	{0x1C,0x22,0x41,0x41,0x7F}, // 'D' 0x44
	{0x41,0x49,0x49,0x49,0x7F}, // 'E' 0x45
	{0x01,0x09,0x09,0x09,0x7F}, // 'F' 0x46
	{0x7A,0x49,0x49,0x41,0x3E}, // 'G' 0x47
	{0x7F,0x08,0x08,0x08,0x7F}, // 'H' 0x48
	{0x00,0x41,0x7F,0x41,0x00}, // 'I' 0x49
	{0x01,0x3F,0x41,0x40,0x20}, // 'J' 0x4A
	{0x41,0x22,0x14,0x08,0x7F}, // 'K' 0x4B
	{0x40,0x40,0x40,0x40,0x7F}, // 'L' 0x4C
	{0x7F,0x02,0x0C,0x02,0x7F}, // 'M' 0x4D
	{0x7F,0x10,0x08,0x04,0x7F}, // 'N' 0x4E
	{0x3E,0x41,0x41,0x41,0x3E}, // 'O' 0x4F
	{0x06,0x09,0x09,0x09,0x7F}, // 'P' 0x50
	{0x5E,0x21,0x51,0x41,0x3E}, // 'Q' 0x51
	{0x46,0x29,0x19,0x09,0x7F}, // 'R' 0x52
	{0x31,0x49,0x49,0x49,0x46}, // 'S' 0x53
	{0x01,0x01,0x7F,0x01,0x01}, // 'T' 0x54
	{0x3F,0x40,0x40,0x40,0x3F}, // 'U' 0x55
	{0x1F,0x20,0x40,0x20,0x1F}, // 'V' 0x56
	{0x3F,0x40,0x38,0x40,0x3F}, // 'W' 0x57
	{0x63,0x14,0x08,0x14,0x63}, // 'X' 0x58
	{0x07,0x08,0x70,0x08,0x07}, // 'Y' 0x59
	{0x43,0x45,0x49,0x51,0x61}, // 'Z' 0x5A
	{0x00,0x7F,0x41,0x41,0x00}, // '[' 0x5B
	{0x02,0x04,0x08,0x10,0x20}, // '\' 0x5C
	{0x00,0x41,0x41,0x7F,0x00}, // ']' 0x5D
	{0x04,0x02,0x01,0x02,0x04}, // '^' 0x5E
	{0x40,0x40,0x40,0x40,0x40}, // '_' 0x5F
	{0x00,0x01,0x02,0x04,0x00}, // '`' 0x60
	{0x20,0x54,0x54,0x54,0x78}, // 'a' 0x61
	{0x7F,0x48,0x44,0x44,0x38}, // 'b' 0x62
	{0x38,0x44,0x44,0x44,0x20}, // 'c' 0x63
	{0x38,0x44,0x44,0x48,0x7F}, // 'd' 0x64
	{0x38,0x54,0x54,0x54,0x18}, // 'e' 0x65
	{0x08,0x7E,0x09,0x01,0x02}, // 'f' 0x66
	{0x0C,0x52,0x52,0x52,0x3E}, // 'g' 0x67
	{0x7F,0x08,0x04,0x04,0x78}, // 'h' 0x68
	{0x00,0x44,0x7D,0x40,0x00}, // 'i' 0x69
	{0x20,0x40,0x44,0x3D,0x00}, // 'j' 0x6A
	{0x7F,0x10,0x28,0x44,0x00}, // 'k' 0x6B
	{0x00,0x41,0x7F,0x40,0x00}, // 'l' 0x6C
	{0x7C,0x04,0x18,0x04,0x78}, // 'm' 0x6D
	{0x7C,0x08,0x04,0x04,0x78}, // 'n' 0x6E
	{0x38,0x44,0x44,0x44,0x38}, // 'o' 0x6F
	{0x7C,0x14,0x14,0x14,0x08}, // 'p' 0x70
	{0x08,0x14,0x14,0x18,0x7C}, // 'q' 0x71
	{0x7C,0x08,0x04,0x04,0x08}, // 'r' 0x72
	{0x48,0x54,0x54,0x54,0x20}, // 's' 0x73
	{0x04,0x3F,0x44,0x40,0x20}, // 't' 0x74
	{0x3C,0x40,0x40,0x20,0x7C}, // 'u' 0x75
	{0x1C,0x20,0x40,0x20,0x1C}, // 'v' 0x76
	{0x3C,0x40,0x30,0x40,0x3C}, // 'w' 0x77
	{0x44,0x28,0x10,0x28,0x44}, // 'x' 0x78
	{0x0C,0x50,0x50,0x50,0x3C}, // 'y' 0x79
	{0x44,0x64,0x54,0x4C,0x44}, // 'z' 0x7A
	{0x00,0x08,0x36,0x41,0x00}, // '{' 0x7B
	{0x00,0x00,0x7F,0x00,0x00}, // '|' 0x7C
	{0x00,0x41,0x36,0x08,0x00}, // '}' 0x7D
	{0x08,0x08,0x2A,0x1C,0x08}, // '~' 0x7E
	{0x08,0x1C,0x2A,0x08,0x08}  // DEL 0x7F (usually unused)
};

void ILI9341_DrawChar(u16 x, u16 y, char c, u16 color, u16 bg, u8 size)
{
	for (u8 i = 0; i < 5; i++) {
		u8 line = font_5x7[(u8)c][i];
		for (u8 j = 0; j < 8; j++) {
			if (line & 0x01) {
				// Draw pixel (scale by size)
				for (u8 xs = 0; xs < size; xs++) {
					for (u8 ys = 0; ys < size; ys++) {
						ILI9341_DrawPixel(x + i*size + xs, y + j*size + ys, color);
					}
				}
				} else {
				for (u8 xs = 0; xs < size; xs++) {
					for (u8 ys = 0; ys < size; ys++) {
						ILI9341_DrawPixel(x + i*size + xs, y + j*size + ys, bg);
					}
				}
			}
			line >>= 1;
		}
	}
}

void ILI9341_voidWriteString(u16 x, u16 y, u16 color, u16 bg, u8 size,const char *str)
{
	while(*str != nul)
	{
		ILI9341_DrawChar(x, y,(*str)-32,color,bg,size);
		x-=20;
		
		str++;
	}
	
}

